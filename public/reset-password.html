<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Open EPH App â€” Reset password</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body { font-family: Inter, Arial, sans-serif; padding: 30px; color:#0f1724; }
        .card { max-width:720px; margin:32px auto; background:#fff; padding:24px; border-radius:8px; box-shadow:0 8px 30px rgba(10,10,30,0.06); }
        .btn { display:inline-block; padding:12px 18px; border-radius:8px; background:#2563eb; color:white; text-decoration:none; font-weight:600; }
        .muted { color:#64748b; margin-top:12px; font-size:14px; }
    </style>
</head>
<body>
<div class="card">
    <h2>Open in EPH App</h2>
    <p id="msg">Trying to open the EPH app...</p>
    <p class="muted">If you are not redirected, use the button below.</p>
    <div style="margin-top:16px;">
        <a id="openButton" class="btn" href="#">Open in app</a>
        <a id="continueWeb" style="margin-left:12px;" href="#" class="btn" target="_blank">Continue on web</a>
    </div>
    <p style="margin-top:16px;"><small id="support" class="muted"></small></p>
</div>

<script>
    (function(){
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token') || '';
      const scheme = 'eph'; // use same scheme you send in email
      const deepLink = token ? `${scheme}://reset-password?token=${encodeURIComponent(token)}` : `${scheme}://reset-password`;
      // Android intent fallback - include package and a browser fallback
      const packageName = 'com.yourcompany.yourapp'; // <- change to your Android package name
      const browserFallback = encodeURIComponent(window.location.href); // current page is fallback
      const intentLink = `intent://reset-password?token=${encodeURIComponent(token)}#Intent;scheme=${scheme};package=${packageName};S.browser_fallback_url=${browserFallback};end`;

      const openButton = document.getElementById('openButton');
      const continueWeb = document.getElementById('continueWeb');
      const msg = document.getElementById('msg');
      const support = document.getElementById('support');

      // Set link hrefs
      openButton.href = intentLink;              // Android will handle intent://
      continueWeb.href = `/reset-password?token=${encodeURIComponent(token)}`; // your regular web reset UI route

      // Try to auto-open:
      // 1) For Android Chrome, intent: will open app. For other browsers, try location = deepLink.
      // 2) Use timeout to detect failed open and show message.
      let opened = false;

      function tryOpen() {
        // For Android Chrome best to use intent link:
        // If user is on Android and using Chrome, go to intent link
        const ua = navigator.userAgent || '';
        if (/Android/i.test(ua)) {
          // change location to intent to trigger app or fallback
          window.location = intentLink;
        } else {
          // iOS / Desktop: try custom scheme
          const now = Date.now();
          window.location = deepLink;
          // if app didn't open in 1s, navigate to web fallback (show button instead)
          setTimeout(function() {
            // If still on the page, show manual instructions
            support.textContent = 'If the app did not open, click "Open in app" or continue on the web.';
          }, 800);
        }
      }

      // perform attempt after small delay (gives mail clients time to open browser)
      setTimeout(tryOpen, 500);
    })();
</script>
</body>
</html>
